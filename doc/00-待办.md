# 问题

# 2025-11-10 -- 读写锁测试用例不支持重复测试

```bash
$ rwlktest
rwspinlock_test: step 1: initrwlock
rwspinlock_test: step 2: concurrent read_acquire
rwspinlock_test: step 3: concurrent read_release
rwspinlock_test: step 4: prepare read_acquire for writer priority test
rwspinlock_test: step 5: writer priority test
rwspinlock_test: step 6: checking for concurrent readers/writers
rwspinlock_test: step 7: checking for concurrent writers
rwspinlock_test: step 8: acquiring multiple locks
rwspinlock_test: step 9: releasing multiple locks
rwspinlock_test: step 10: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 11: multiple writer priority test
rwspinlock_test: step 12: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 13: multiple writer priority test
rwspinlock_test: step 14: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 15: multiple writer priority test
rwspinlock_test: step 16: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 17: multiple writer priority test
rwspinlock_test: step 18: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 19: multiple writer priority test
rwspinlock_test: step 20: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 21: multiple writer priority test
rwspinlock_test: step 22: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 23: multiple writer priority test
rwspinlock_test: step 24: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 25: multiple writer priority test
rwspinlock_test: step 26: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 27: multiple writer priority test
rwspinlock_test: step 28: prepare read_acquire for multiple writer priority test
rwspinlock_test: step 29: multiple writer priority test
rwspinlock_test: step 30: done
rwspinlock_test(0): 0
rwspinlock_test(3): 0
rwspinlock_test(2): 0
rwspinlock_test(1): 0
rwlktest: 4/4 CPUs succeeded
$ rwlktest
rwspinlock_test: step 1: initrwlock
rwspinlock_test: step 2: concurrent read_acquire
rwspinlock_test: step 3: concurrent read_release
rwspinlock_test: step 4: prepare read_acquire for writer priority test
rwspinlock_test: step 5: writer priority test
```
读写锁bug第一次测试通过，第二次测试失败，原因不明。

## 可能的原因，第一次测试都能通过，第二次测试无法通过，测试用例中的静态变量累积了状态，导致第二次测试时状态不一致。目前未发现其他bug，实现是否正确待验证。

从测试代码的设计来看，有几个关键点：

1. 静态变量的使用：
  - barrier变量用于同步所有CPU，每次调用rwspinlock_test_step时递增
  - flag、v、writer_count等变量用于测试不同场景
  - 这些静态变量在测试过程中累积状态，不会被重置
2. 测试流程：

  - 测试分为30个步骤，每个步骤都需要所有CPU同步
  - 测试包括并发读、写者优先级、多个写者优先级等多种场景
  - 每个场景都依赖于前一个场景的状态
3. 死锁位置：
  - 死锁总是发生在第6步"checking for concurrent readers/writers"
  - 这一步测试CPU0执行写操作，其他CPU执行读操作
  - 第二次测试时，可能因为状态不一致导致死锁
从这些观察来看，测试用例很可能设计为只支持单次测试。原因如下：
  - 静态变量累积：测试中的静态变量在每次测试后不会被重置，导致第二次测试时状态不一致。
  - 测试依赖性：测试步骤之间有依赖关系，后续步骤依赖于前面步骤的状态。
  - 资源清理：测试结束后没有进行资源清理，导致第二次测试时资源状态不正确。
  - 因此，我认为这个测试用例的逻辑确实只支持单次测试，不支持多次测试。如果需要多次测试，需要在每次测试开始时重置所有静态变量和资源状态。

这解释了为什么第一次测试能够通过，但第二次测试就会死锁。这并不是读写锁实现的问题，而是测试用例设计的问题。